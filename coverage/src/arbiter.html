
<!doctype html>
<html lang="en">
  <head>
    <title>Code coverage report for arbiter</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../style/reset.css">
    <link rel="stylesheet" href="../style/style.css">
  </head>
  <body>
   <div id="page-container">
      <header>
        <nav>
          
<ul class="inline-list">
    <li>
      <a href="../index.html">All Files</a> /
    </li>
    <li>
      <a href="./index.html">src</a> /
    </li>

  <li>arbiter.lua</li>
</ul>

        </nav>
      </header>

      <main>
        <header class="hit-miss-statistics">
          
<ul class="inline-list">
  <li>
    <span class="strong">100.00%</span>
    <span class="quiet">Rate</span>
  </li>
  <li>
    <span class="strong">38</span>
    <span class="quiet">Hits</span>
  </li>
  <li>
    <span class="strong">0</span>
    <span class="quiet">Missed</span>
  </li>
</ul>

<div class="hit-percentage-status hit-percentage-status-high"></div>

        </header>
        <section id="content">
          
  <section class="file-coverage">

    <ul class="line-numbers undecorated">
        <li>1</li>
        <li>2</li>
        <li>3</li>
        <li>4</li>
        <li>5</li>
        <li>6</li>
        <li>7</li>
        <li>8</li>
        <li>9</li>
        <li>10</li>
        <li>11</li>
        <li>12</li>
        <li>13</li>
        <li>14</li>
        <li>15</li>
        <li>16</li>
        <li>17</li>
        <li>18</li>
        <li>19</li>
        <li>20</li>
        <li>21</li>
        <li>22</li>
        <li>23</li>
        <li>24</li>
        <li>25</li>
        <li>26</li>
        <li>27</li>
        <li>28</li>
        <li>29</li>
        <li>30</li>
        <li>31</li>
        <li>32</li>
        <li>33</li>
        <li>34</li>
        <li>35</li>
        <li>36</li>
        <li>37</li>
        <li>38</li>
        <li>39</li>
        <li>40</li>
        <li>41</li>
        <li>42</li>
        <li>43</li>
        <li>44</li>
        <li>45</li>
        <li>46</li>
        <li>47</li>
        <li>48</li>
        <li>49</li>
        <li>50</li>
        <li>51</li>
        <li>52</li>
        <li>53</li>
        <li>54</li>
        <li>55</li>
        <li>56</li>
        <li>57</li>
        <li>58</li>
        <li>59</li>
        <li>60</li>
        <li>61</li>
        <li>62</li>
        <li>63</li>
        <li>64</li>
        <li>65</li>
        <li>66</li>
        <li>67</li>
        <li>68</li>
        <li>69</li>
        <li>70</li>
        <li>71</li>
        <li>72</li>
        <li>73</li>
        <li>74</li>
        <li>75</li>
        <li>76</li>
        <li>77</li>
        <li>78</li>
        <li>79</li>
        <li>80</li>
        <li>81</li>
        <li>82</li>
        <li>83</li>
        <li>84</li>
        <li>85</li>
    </ul>

    <ul class="line-coverages undecorated">
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">19x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">2x</li>
        <li class="line-hit">15x</li>
        <li class="line-hit">8x</li>
        <li class="line-hit">7x</li>
        <li class="line-hit">7x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-hit">8x</li>
        <li class="line-empty">
</li>
        <li class="line-hit">25x</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">17x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">16x</li>
        <li class="line-hit">19x</li>
        <li class="line-hit">17x</li>
        <li class="line-hit">19x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">25x</li>
        <li class="line-hit">17x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">8x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-hit">6x</li>
        <li class="line-hit">2x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">4x</li>
        <li class="line-hit">4x</li>
        <li class="line-hit">7x</li>
        <li class="line-hit">6x</li>
        <li class="line-hit">2x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-hit">1x</li>
        <li class="line-hit">1x</li>
        <li class="line-hit">1x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
        <li class="line-empty">
</li>
        <li class="line-empty">
</li>
        <li class="line-hit">1x</li>
    </ul>

    <ul class="code undecorated">
        <li class="line-empty">--- Handles content negotiation with the client.</li>
        <li class="line-empty">-- @module arbiter</li>
        <li class="line-empty">-- @author DarkWiiPlayer</li>
        <li class="line-empty">-- @license Unlicense</li>
        <li class="line-empty">
</li>
        <li class="line-hit">local arbiter = {}</li>
        <li class="line-empty">
</li>
        <li class="line-hit">arbiter.__index = arbiter</li>
        <li class="line-empty">
</li>
        <li class="line-empty">--- Escapes all the special pattern characters in a string</li>
        <li class="line-empty">-- @tparam string pattern A string to escape</li>
        <li class="line-empty">local function patescape(pattern)</li>
        <li class="line-hit">	return pattern:gsub(&#39;[%^%$%(%)%%%.%[%]%+%-%?%*]&#39;, function(char) return &#39;%&#39;..char end)</li>
        <li class="line-empty">end</li>
        <li class="line-empty">
</li>
        <li class="line-empty">--- Takes a content type string and turns the string into patterns to match said type(s)</li>
        <li class="line-empty">-- @tparam string accept A single content-type</li>
        <li class="line-empty">local function pattern(accept)</li>
        <li class="line-hit">	local s, t = accept.s, accept.type</li>
        <li class="line-hit">	if s == 1 then</li>
        <li class="line-hit">		return &#39;.+&#47;.+&#39;</li>
        <li class="line-hit">	elseif s == 2 then</li>
        <li class="line-hit">		return &quot;^&quot; .. patescape(t:match(&#39;^[^&#47;]+&#47;&#39;))..&quot;.+&quot;</li>
        <li class="line-hit">	elseif s == 3 then</li>
        <li class="line-hit">		return &quot;^&quot; .. patescape(t)..&quot;$&quot;</li>
        <li class="line-empty">	end</li>
        <li class="line-empty">end</li>
        <li class="line-empty">
</li>
        <li class="line-empty">--- Parses an &quot;accept&quot; header and returns its entries.</li>
        <li class="line-empty">-- Values are returned as: `{q = &lt;Q-Value&gt;, s = &lt;Specificity&gt;, type = &lt;content type&gt;}`</li>
        <li class="line-empty">-- where specificity can be 1 for `*&#47;*`, 2 for `&lt;type&gt;&#47;*` or 3 for `&lt;type&gt;&#47;&lt;subtype&gt;`</li>
        <li class="line-empty">-- @tparam string accept The full HTTP Accept header</li>
        <li class="line-hit">function arbiter.new(accept)</li>
        <li class="line-hit">	local new = setmetatable({ pairs=pairs, ipairs=ipairs, accept=accept }, arbiter)</li>
        <li class="line-empty">
</li>
        <li class="line-hit">	for param in accept:gmatch(&#39;[^, ]+&#39;) do</li>
        <li class="line-hit">		local m, n = param:match(&quot;([^&#47;]+)&#47;([^;]+)&quot;)</li>
        <li class="line-hit">		local s = m == &#39;*&#39; and 1 or n == &#39;*&#39; and 2 or 3</li>
        <li class="line-hit">		local q = tonumber(param:match(&#39;;q=([%d.]+)&#39;)) or 1</li>
        <li class="line-hit">		table.insert(new, {q=q, s=s, type=m..&#39;&#47;&#39;..n})</li>
        <li class="line-empty">	end</li>
        <li class="line-empty">
</li>
        <li class="line-hit">	table.sort(new, function(a, b)</li>
        <li class="line-hit">		return a.q&gt;b.q</li>
        <li class="line-hit">			or a.q == b.q and a.s&gt;b.s</li>
        <li class="line-hit">			or a.q == b.q and a.s == b.s and a.type &lt; b.type</li>
        <li class="line-empty">	end)</li>
        <li class="line-empty">
</li>
        <li class="line-hit">	for i, value in new:ipairs() do</li>
        <li class="line-hit">		new[i].pattern = pattern(value)</li>
        <li class="line-empty">	end</li>
        <li class="line-empty">
</li>
        <li class="line-hit">	return new</li>
        <li class="line-empty">end</li>
        <li class="line-empty">
</li>
        <li class="line-empty">--- Picks the client&#39;s preferred content type from a list.</li>
        <li class="line-empty">-- When given a list of strings as arguments or in a sequence, the best match will be returned.</li>
        <li class="line-empty">-- When given a table, the keys will be treated as content types</li>
        <li class="line-empty">-- and the selected type will be returned along with its corresponding value.</li>
        <li class="line-hit">function arbiter:pick(available, ...)</li>
        <li class="line-hit">	if type(available) == &quot;string&quot; then</li>
        <li class="line-hit">		return self:pick({available, ...})</li>
        <li class="line-empty">	end</li>
        <li class="line-empty">
</li>
        <li class="line-hit">	if type(available[1]) == &quot;string&quot; then</li>
        <li class="line-hit">		for _, entry in self:ipairs() do</li>
        <li class="line-hit">			for _, name in ipairs(available) do</li>
        <li class="line-hit">				if name:find(entry.pattern) then</li>
        <li class="line-hit">					return name</li>
        <li class="line-empty">				end</li>
        <li class="line-empty">			end</li>
        <li class="line-empty">		end</li>
        <li class="line-empty">	else</li>
        <li class="line-hit">		for _, entry in self:ipairs() do</li>
        <li class="line-hit">			for name, value in pairs(available) do</li>
        <li class="line-hit">				if name:find(entry.pattern) then</li>
        <li class="line-hit">					return name, value</li>
        <li class="line-empty">				end</li>
        <li class="line-empty">			end</li>
        <li class="line-empty">		end</li>
        <li class="line-empty">	end</li>
        <li class="line-hit">	return nil, &quot;Content type negotiation failed for &#39;&quot;..self.accept..&quot;&#39;&quot;</li>
        <li class="line-empty">end</li>
        <li class="line-empty">
</li>
        <li class="line-hit">return arbiter</li>
    </ul>

  </section>

        </section>
      </main>

      <footer class="quiet">
        Code coverage generated by <a href="https://keplerproject.github.io/luacov/" target="_blank">LuaCov</a> at 2022-12-18 14:23:12
      </footer>
    </div>
  </body>
</html>
